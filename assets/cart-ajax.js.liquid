// POST to cart/change.js returns the cart in JSON
changeItem = function(line, quantity, callback) {
  var $body = $(document.body),
      params = {
        type: 'POST',
        url: cartChangeUrl,
        data: 'quantity=' + quantity + '&line=' + line,
        dataType: 'json',
        success: function(cart) {
          jQuery.getJSON(cartUrl,function (cart, textStatus) {
            callback(cart); 
          });
        },
        error: function(XMLHttpRequest, textStatus) {
          console.log(XMLHttpRequest, textStatus);
        }
      };
  jQuery.ajax(params);
};

updateQuantity = function(line, qty,callback) {
  isUpdating = true;
  setTimeout(function() {
    changeItem(line, qty,callback);
  }, 250);
}

validateQty = function (qty) {
  if((parseFloat(qty) == parseInt(qty)) && !isNaN(qty)) {
    // We have a valid number!
  } else {
    // Not a number. Default to 1.
    qty = 1;
  }
  return qty;
};

buildCart = function (cart,showCart) {
  if (cart.item_count === 0) {
    $('[data-cart-count]').hide();
  }
  else{
    $('[data-cart-count]').show();
  }


  $('[data-drawer-body]').load(mainCartUrl+'?view=jsonData', function() {
    if(showCart){
      $('body').addClass('side_Drawer_open');
      $('.wrapper-overlay').css({"display": "block"});
    }
  });

};


// POST to cart/add.js returns the cart in JSON
$('[action="'+cartAdd+'"]').on('submit',function(evt) {
  evt.preventDefault();
  $('body').find('.productErrors').hide().html('');
  var submit = $(this).find('[type="submit"]');
  submit.addClass('is-loading');
  params = {
    type: 'POST',
    url: cartAddUrl,
    data: jQuery(this).serialize(),
    dataType: 'json',
    // beforeSend: function(jqxhr, settings) {
    //   $body.trigger('beforeAddItem.ajaxCart', form);
    // },
    success: function(line_item) {           
      $('body').removeClass('quickview-open'); 

  $('[data-drawer-body]').html(preLoadLoadGif);
      $('body').find('[data-side-drawer]').attr('class','side_drawer_wrapper')
      $('body').find('[data-drawer-title]').html('{{'sections.cart.title' | t}}');
      $('body').find('[data-side-drawer]').attr('id','mini__cart').addClass('mini_cart');
      $('body').addClass('side_Drawer_open');
      jQuery.getJSON(cartUrl, function (cart, textStatus) {
        buildCart(cart,true);
        setTimeout(function(){
          submit.removeClass('is-loading');
        },1000)
      });
    },
    error: function(XMLHttpRequest, textStatus) {
      if ((typeof errorCallback) === 'function') {
        errorCallback(XMLHttpRequest, textStatus);
      }
      else {
        console.log(XMLHttpRequest);
        console.log(XMLHttpRequest.responseJSON.description);
        $('body').find('.productErrors').html(XMLHttpRequest.responseJSON.description).show();
      }
      setTimeout(function(){
        submit.removeClass('is-loading');
      },1000)
    }
  };
  jQuery.ajax(params);
});

// Update quantity based on input on change

$(document).on('click', '.quantity-button', function(evt) {
  evt.preventDefault();
  var $el = $(this),
      parent = $el.closest('.media-link'),
      line = $el.data('line'),
      $qtySelector = $el.closest('.quantity').find('.ajaxcart__qty-num');
  var qty = $qtySelector.val();
  parent.addClass('disabled')
  if(qty){
    qty = parseInt(qty.replace(/\D/g, ''));
  }

  var qty = validateQty(qty);

  // Add or subtract from the current quantity
  if ($el.hasClass('ajaxcart__qty--plus')) {
    qty += 1;
  } else {
    qty -= 1;
    if (qty <= 0) qty = 0;
  }
  $qtySelector.val(qty);
  if (line) {
    updateQuantity(line, qty,buildCart);
  } 
});

// Update quantity based on input on change
$(document).on('change', '.ajaxcart__qty-num', function(evt) {
  evt.preventDefault();
  var $el = $(this),
      parent = $el.closest('.media-link'),
      line = $el.data('line'),
      qty = parseInt($el.val().replace(/\D/g, ''));

  parent.addClass('disabled')
  var qty = validateQty(qty);

  // If it has a data-line, update the cart
  if (line) {
    updateQuantity(line, qty,buildCart);
  }
});

$('body').on('click','.openCartDrawer',function(e){
  e.preventDefault();
  $('[data-drawer-body]').html(preLoadLoadGif);
  $('body').find('[data-drawer-title]').html('{{'sections.cart.title' | t}}');
  $('body').find('[data-side-drawer]').attr('class','side_drawer_wrapper')
  $('body').find('[data-side-drawer]').attr('id','mini__cart').addClass('mini_cart');
  $('body').addClass('side_Drawer_open');
  jQuery.getJSON(cartUrl, function (cart, textStatus) {
    buildCart(cart,true);
  });
});

$(document).on('click', '.sd_mini_removeproduct', function(evt) {
  evt.preventDefault();
  var $el = $(this),
      parent = $el.closest('.media-link'),
      line = $el.attr('line');
  parent.addClass('disabled')
  // If it has a data-line, update the cart
  if (line) {
    updateQuantity(line, 0,buildCart);
  }
})


$(document).on('change ', '[name=note]', function(evt) {
  var currentVal = $(this).val();
  console.log('test',currentVal)
  $.ajax({
    url: cartUpdateUrl,
    type: 'POST',
    data: {note: currentVal},
    dataType: 'json',
    success: function(result) { 
    }
  });
})


$(document).on('click ', '.cartDrawerNote', function(evt) {
  $(this).toggleClass('active');
  var textArea = $(this).siblings('.cartNoteContainer');
  textArea.slideToggle()
})