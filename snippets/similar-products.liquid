
 {% comment %}
  Number of related items per row,
  and number of rows.
  {% endcomment %}

  {% assign number_of_related_products_per_row = section.settings.related_grid_num %}
  {% assign number_of_rows = section.settings.related_grid_row %}

  {% comment %}
  Heading.
  Leave blank if you don't need one.
  {% endcomment %}

  {% assign heading = section.settings.related_title %}

  {% comment %}
  Set either or both to true, if you want
  to limit yourself to items with same vendor, and/or type.
  {% endcomment %}

  {% assign same_vendor = false %}
  {% assign same_type = false %}

  {% comment %}
  Collections to ignore.
  Never pick related items from those.
  {% endcomment %}

  {% assign exclusions = 'frontpage,all' | split: ',' %}

  {% comment %}
  Looking for a relevant collection.
  {% endcomment %}

  {% if product.metafields.c_f['Related Products'] %}
  {% assign collection = collections[product.metafields.c_f['Related Products']] %}
  {% endif %}

  {% assign found_a_collection = false %}
  {% if collection and collection.all_products_count > 1 %}
  {% unless exclusions contains collection.handle %}
  {% assign found_a_collection = true %}
  {% endunless %}
  {% endif %}
  {% unless found_a_collection %}
  {% for c in product.collections %}
  {% unless exclusions contains c.handle or c.all_products_count < 2 %}
  {% assign found_a_collection = true %}
  {% assign collection = c %}
  {% break %}
  {% endunless %}
  {% endfor %}
  {% endunless %}

  {% comment %}
  If we have a relevant collection.
  {% endcomment %}

  {% if found_a_collection %}

  {% assign counter = 0 %}
  {% assign break_at = number_of_rows | times: number_of_related_products_per_row %}
  {% assign current_product = product %}

  {% capture related_items %}

  {% for product in collection.products %}
  {% unless product.handle == current_product.handle %}
  {% unless same_vendor and current_product.vendor != product.vendor %}
  {% unless same_type and current_product.type != product.type %}

  <li class="product-base">
    <a href="{{product.url}}">
      <div class="product-imageSliderContainer">
        <div class="img-responsive">
          <img src="{{product.featured_image | img_url:'500x'}}" alt="{{product.title}}" title="{{product.title}}">
        </div>
      </div>
      <div class="product-productMetaInfo">
        <div class="product-product small-size">{{product.title}}</div>
        <div class="product-price">
          {% if product.compare_at_price > product.price %}
          <span class="small-size product-price-detail">
            <span class="product-discountedPrice">{{product.price | money}}</span>
            <span class="product-strike"><del>{{product.compare_at_price}}</del></span>
          </span>

          {% if settings.show_saved_amount %}        
          {% if settings.saved_amount_style == 'percentage' %}
          <span class="percent-off">{{ product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round: 2 | append: "% OFF"}}</span>
          {% else %}
          <span class="percent-off">{{ product.compare_at_price | minus: product.price | money | append: " OFF"}}</span>
          {% endif %}
          {% endif %}
          {% else %}
          <span class="small-size product-price-detail">
            <span class="product-discountedPrice">{{product.price | money}}</span>
          </span>
          {% endif %}
        </div>
      </div>
    </a>
  </li>

  {% endunless %}
  {% endunless %}
  {% endunless %}
  {% endfor %}

  {% endcapture %}
  {% assign related_items = related_items | trim %} 
  {% endif %}


<div id="similarItemContainer" style="display:none">
  {% if related_items.size > 20 %}
  <ul class="results-base results-similarGrid">
    {{ related_items }}
  </ul>
  {%else%}
  <div class="SimilarNoResults" style="">
    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="49px" height="50px">
      <image x="0px" y="0px" width="49px" height="50px" xlink:href="data:img/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAAyCAQAAABfAfs5AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAHdElNRQfkARYRMQNLo02IAAADSUlEQVRYw7WXW0hUQRjHf7tbWmoXzZLSQLuTkRYZWg9qmWWXpaALPgUF0UNEPXSnt25ERVgE4UMUGFRvZQUVRJGFaKBRS5rZRYtwTVkr09I9vZzGOXvO2Z096jcv3+z8v+83c/abM3NchLN4FlFIDqkk4gJ+4+cVz6jiE0Ng2ZynGc2y/aCSTcQMJn0m1/lrk36g1VPqLL2Hw/yMmP5/u0NatAA31yxT9dNNj+XIG+aGT+ky9DK4yGrDL3W8wIePNrrxMJ7pZJFJPmMlTRu7uaG2gjTeG+b3iGLclsp0jhMwaHeqAEZTLYV8Z2sE/RzuGh5kcWTEJSmgjjlK6z4mxXxjSnhxsSSuZaLakwX2SnG3wgljeS2EzUxWBgCUS5CV9rJDkmx5VABIoFbEvmWUtSiOFiGqiBIAkEufiN9oLfEKQQ+zHSDgpshQaS24ovaHhbGlIkMXk8zDSTQJgdchwo1P5FhnHpxPuu77eeIQEeS28OebEZl4dL+OgEMEPBVeihmRKvwPjgHQgqZ7Y8yIOOH7B4EI0KN7I82IAesfBOIvfbqnhQ65CQo/TjWfhcXb7Wtw0yr8GYNApIkH1GVGNAl/rqit6C1beB1mhI9O3Z/GTMeIAuG1mAdH8FjszP0OAcl06hmC0nokOyAQPpuzOpLtEhkazEULkMEvIdnhAJDERxF/1E50WbpKZkSNGLh5dTDBTjSLXiErjxKwXjoxj4UTnpOE26MATJKOgi8khpOOk27h/cqQqbyUprY5kjyfP5L8pMLrpMDwcVCmMqcSuqWQRg6GWfhy7kmXAg2N02oL9xogGi2cISek0tPZLm1WuZ2yTuoK6S/jZkjhaTTyjlYCxJLCNOYRbzvFI5xQWckSqUYit178hv4etceVzAWbz5XQ9pxc8qR3g4bGFjUIZHOWaoK2yT9TQan+RiviqzTSRpEqBCCLfdynVczzDx3UUMZaw1cSZNIqQfqM9zGXAiiBZJLwoPGLdptLxAIeSmXSzQYeRLMWNcsTZ4aGRoC8oUdAkeGPb2fhcEBKDJAvZA0HZLGhujpYNRwQr6G4f1Ls/FpjZw34WSN6MXQNPQJq+M0K0asfDgRUEaRQ98tVtp4z20Y+Lp5y9R89MxMHU4TKlQAAAABJRU5ErkJggg=="></image>
    </svg>
    <p>{{'general.no_similar_found' | t}} </p>
  </div>
  {%endif%}
</div>